# web-visualization-system 技术方案

## 目录

- [背景与目标](##❇️ 背景与目标)
  - [项目背景](###✅ 项目背景)
  - [项目目标](###✅ 项目目标)

- [项目干系人](##❇️ 项目干系人)
- [目录结构规范](##❇️ 目录结构规范)
  - [工程规范约定](###✅ 工程规范约定)
  - [根目录结构](###✅ 根目录结构)
- [总体设计](##❇️ 总体设计)
- [详细设计](##❇️ 详细设计)
  - [POI 方案设计](###✅ POI 方案设计)
    - [方案价值&实现思路](####方案价值&实现思路)
    - [一期方案](####一期方案)
- [开发文档](##❇️ 开发文档)



## ❇️ 背景与目标

### ✅ 项目背景

### ✅ 项目目标

1. 展现目的地预测/出行模式分析成果：

   - 为研究工作提供可视化服务

2. 创造项目开发的实践机会：

   - 选用流行的Web前后台技术，锻炼项目参与人员的开发能力

3. 挖掘轨迹目的地算子模型的应用场景：

   - 目的地预测模型可作为基础算子部署到各类智能交通导航与个性化位置服务系统的实际应用场景中。本项目有助于验证各预测模型的有效性。

   

## ❇️ 项目干系人

| 角色   | 负责人(R) | 参与人                               | 备注 |
| ------ | --------- | ------------------------------------ | ---- |
| 前端   | 王锦添    | 王锦添、窦晨                         |      |
| 后段   | 丁劲宸    | 丁劲宸                               |      |
| 需求方 | 桂志鹏    | 桂志鹏、王锦添、窦晨、丁劲宸、刘宇航 |      |



## ❇️ 目录结构规范

### ✅ 工程规范约定

- 工程下所有文件或文件夹命名遵循(小写 + `-` 连字符)
- 根路径下目录除配置文件和 src 外只能存在 bin、config、public、test配置相关目录
- 公共类库相关文件暂只支持存在 api、assets、styles、hooks、lib、store、types、constants，按需以文件或目录创建，如 style.scss 或 styles/index.scss，支持创建子目录
- pages 目录，支持 spa、mpa、mpa + spa
- spa 打包入口文件和根组件命名必须是 main.tsx、app.tsx
- 页面和组件支持可嵌套

### ✅ 根目录结构

```
├── src
│   ├── api  // 后台接口服务
│   │   └── index.ts 
│   ├── assets // 公共静态资源目录
│   │   ├── fonts // 字体文件
│   │   ├── icons // icon
│   │   └── images // 图片
│   ├── styles // css样式 单独从assets拎出来是考虑到sass是需要编译处理而不像字体图标直接可使用
│   │   ├── index.scss // 默认全局样式
│   │   ├── index.module.scss // css module
│   ├── components // 公共组件
│   │   ├── component-a
│   │   │   ├── api// 服务接口
│   │   │   ├── assets // 静态资源 同上
│   │   │   ├── lib // 类库 同上
│   │   │   ├── constants // 常量 同上
│   │   │   ├── styles // 样式 同上
│   │   │   ├── types // 类型声明 同上
│   │   │   ├── components // 子组件
│   │   │   │   ├── sub-component // 结构同上
│   │   │   │   │   ├── assets
│   │   │   │   │   └── index.tsx
│   │   │   └── index.tsx // 组件入口
│   │   └── component-b
│   │       └── index.tsx
│   ├── hooks // React Hooks
│   │   └── use-hook-a // 文件夹
│   │   │   └── index.ts
│   ├── lib // 工具库 类似于utils
│   │   ├── create-store // 以文件夹 通过index入口暴露
│   │   │   └── index.ts
│   ├── store // 公共状态库
│   │   ├── index.ts
│   │   │   └── features
│   │   │   │   ├── sliceA
│   │   │   │   │   └── index.ts // the Redux logic for the feature
│   │   │   │   ├── sliceB
│   │   │   │   │   └── index.ts
│   └── types // ts类型声明
│   │   ├── index.d.ts
│   ├── pages // MPA pages下的每个文件夹都会被作为一个entry来进行打包
│   │   ├── page-a
│   │   │   ├── app.tsx // 根组件 命名固定
│   │   │   ├── main.tsx // 打包入口文件 命名固定
│   │   │   ├── assets // 结构与最外层assets一样 结构与最外层assets一样
│   │   │   ├── components // page-a下公共业务组件 结构与最外层components一样
│   │   │   ├── hooks // views公共hooks 结构与最外层hooks一样
│   │   │   ├── lib // views公共工具库 结构与最外层lib一样
│   │   │   ├── routes // 路由
│   │   │   │   └── index.ts
│   │   │   ├── store // views公共状态  结构与最外层store一样
│   │   │   ├── styles // views公共样式  结构与最外层styles一样
│   │   │   │   ├── index.scss
│   │   │   ├── constants // views公共常量 结构与最外层constants一样
│   │   │   │   └── index.ts
│   │   │   └── types // views公共st类型声明 结构与最外层types一样
│   │   │       ├── index.d.ts
│   │   │   ├── views // 页面
│   │   │   │   ├── list // 列表页 支持多层嵌套 如 list/module-a/module-b，子目录结构同外层
│   │   │   │   ├── ├── lib
│   │   │   │   ├── ├── assets // 结构与最外层assets一样
│   │   │   │   ├── ├── components // 结构与最外层components一样
│   │   │   │   ├── ├── hooks // 结构与最外层hooks一样
│   │   │   │   ├── ├── stores // 结构与最外层stores一样
│   │   │   │   ├── ├── api  // 结构与最外层api一样
│   │   │   │   ├── ├── constants // 结构与最外层constants一样
│   │   │   │   ├── ├── styles // 结构与最外层styles一样
│   │   │   │   ├── ├── types// 结构与最外层types一样
│   │   │   │   └── index.tsx
│   │   │   │   └── detail // 详情页 子目录同
│   │   │   │       └── index.tsx
│   │   └── page-b
```



## ❇️ 总体设计



## ❇️ 详细设计

### ✅ POI 方案设计

#### 方案价值&实现思路

- 宏观展示行政区块内 (以深圳市为例) 的 POI 分布
  - 挖掘行政区块的功能圈分布模式
    - 语义地图 (基于区块内数量占比最大的 POI 展示区块权重)
    - POI 的环状占比图
  - 辅助城市版图规划 (例如形成商圈/生活圈/工作圈)
- 结合轨迹 OD 数据定制个体用户活动链
  - 挖掘个体用户(天/周/月)出行模式
    - OD 赋予 POI 属性，构成一天/一周/一月的轨迹活动链
  - 基于活动链可衍生出更多的数据分析方案及图表📈展示
    - 单条轨迹活动链 (多表联动)
      - 折线图：POI 占比在各时间(轨迹)节点的展示
      - 环状图：某时间(轨迹)节点的 POI 占比

#### 一期方案

1️⃣ 获取 POI 数据

- [ ] 筛选有用的 POI 字段 (type / typeId)

- [ ] 组织数据结构

![image-20220723083715054](/Users/tian/Library/Application Support/typora-user-images/image-20220723083715054.png)

2️⃣ 展示 POI 数据

> 基于 [GPUGridLayer](https://deck.gl/docs/api-reference/aggregation-layers/gpu-grid-layer) 展示

![image-20220731104424181](/Users/tian/Library/Application Support/typora-user-images/image-20220731104424181.png)

3️⃣ POI 数据交互

- [x] 鼠标 Hover 展示 Tooltip，内容包含：

  - POI 总数

  - 各类 POI 数目

- [x] 鼠标点击某区块，自适应放大该区块，并下钻到更细粒度 POI

  - [x] 下钻效果过渡
    - [View State Transitions](https://deck.gl/docs/developer-guide/view-state-transitions#view-state-transitions)
    - [FlyToInterpolator](https://deck.gl/docs/api-reference/core/fly-to-interpolator#flytointerpolator)

  - [x] 展示 cell 单元格 POI 的环状占比图

  - [x] 支持视角初始化操作 `ESC`

  - [x] 支持双(多)选操作，两两区块间以 [GreatCircleLayer](https://deck.gl/docs/api-reference/geo-layers/great-circle-layer) 连接 (可实现区域 POI 种类占比的静态对比分析)

#### 二期方案

1️⃣ POI 属性赋值 OD

- [ ] 调用接口展示轨迹 OD 数据
  - 什么形式展示 ？
  - 首屏展示的数据量大小 ？
  - OD 数据的数据结构 ？
- [ ] OD 与 POI 区块的联动赋值
  - 如何联动 ？(基于 OD 坐标获得对应 POI 区块，然后将区块属性赋值给 OD 数据字段)

2️⃣ UI 优化

- [ ] 高亮所有被选中的区块，淡化其余区块，同时支持回退操作
- [ ] 环状统计图位置及样式优化



## ❇️ 开发文档

- [deck.gl events](https://deck.gl/docs/developer-guide/interactivity#picking)

  - [getTooltip](https://deck.gl/docs/api-reference/core/deck#gettooltip)
    - `<DeckGL />` 根节点上的属性，任何鼠标移动都会被监听，需要基于 `picked` 属性判断是否在目标元素上方。

- [deck.gl CPUGridLayer](https://deck.gl/docs/api-reference/aggregation-layers/cpu-grid-layer#cpugridlayer)

  - [getColorValue](https://deck.gl/docs/api-reference/aggregation-layers/cpu-grid-layer#getcolorvalue)

    - After data objects are aggregated into cells, this accessor is called on each cell to get the value that its color is based on

    - 该字段接收一个函数。函数内可获得各个 cell 单元内被聚合的元数据，开发人员可根据这些元数据自定义生成 color 权重 (number 类型) 并返回，各 cell 单元格会调用该函数，并基于生成的权重在 [colorRange](https://deck.gl/docs/api-reference/aggregation-layers/cpu-grid-layer#colorrange) 中映射合适的颜色进行渲染展示。

    - `getColorValue` 会覆盖 `getColorWeight` + `colorAggregation`

    - > `getColorValue` 返回的 `colorWeight` 需要结合 `colorDomain` 和 `colorRange` 一同使用，`colorDomain` 最佳实践设置为颜色种类数。

- deck.gl Transitions

  - [View State Transitions](https://deck.gl/docs/developer-guide/view-state-transitions#view-state-transitions)
  - [FlyToInterpolator](https://deck.gl/docs/api-reference/core/fly-to-interpolator#flytointerpolator)
  
- [deck.gl extensions](https://deck.gl/docs/api-reference/extensions/overview)

  - [BrushingExtension](https://deck.gl/docs/api-reference/extensions/brushing-extension)
  - [FillStyleExtension](https://deck.gl/docs/api-reference/extensions/fill-style-extension)
  - [PathStyleExtension](https://deck.gl/docs/api-reference/extensions/path-style-extension)






